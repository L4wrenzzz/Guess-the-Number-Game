<!DOCTYPE html>
<html>
<head>
    <title>Guess the Number</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-color: #16213e;
            --primary-purple: #9a4ef2;
            --hover-purple: #a966f5;
            --text-color: #e0e0e0;
            --border-color: #4a4a68;
            --font-family: 'Poppins', sans-serif;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        h1, h2 { margin: 0; color: #fff; }
        p { line-height: 1.6; }
        .card {
            background: var(--card-color);
            padding: 30px;
            border-radius: 20px;
            max-width: 550px;
            width: 95%;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
            margin: 20px auto;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        input, select {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            width: 100%;
            margin: 8px 0;
            font-family: var(--font-family);
            font-size: 1em;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin: 8px 0;
            background: var(--primary-purple);
            color: #fff;
            font-family: var(--font-family);
            font-weight: 600;
            font-size: 1em;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
        }
        button:hover {
            background: var(--hover-purple);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(154, 78, 242, 0.4);
        }
        .top-menu { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .top-menu button, .top-menu form { width: auto; }
        
        .section { display: none; margin-top: 20px; text-align: left; background: var(--bg-color); padding: 20px; border-radius: 15px; }
        .section ul { list-style: none; padding: 0; max-height: 300px; overflow-y: auto; }
        .section li { padding: 8px 0; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; flex-wrap: wrap; }
        .stats-box { border-top: 1px solid var(--border-color); margin-top: 15px; padding-top: 15px; }

        .difficulty-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .difficulty-container label { flex-shrink: 0; margin-bottom: 0; }
        .difficulty-container select { width: auto; flex-grow: 1; margin: 0; }
        .difficulty-container button { width: auto; flex-shrink: 0; margin: 0; }
        
        @media (max-width: 520px) {
            .difficulty-container { flex-direction: column; }
            .difficulty-container select, .difficulty-container button { width: 100%; }
        }
        
        .timer { font-size: 1.2em; color: var(--primary-purple); font-weight: 600; margin-top: 10px; }
        img { display: block; margin: 15px auto; border-radius: 10px; }
        .game-message {
            font-weight: 600;
            font-size: 1.1em;
            white-space: pre-wrap;
        }

        .player-title {
            font-weight: 600;
            padding-right: 8px;
        }
        .title-Newbie { color: #b0bec5; text-shadow: 0 0 5px rgba(176, 190, 197, 0.5); }
        .title-Rookie { color: #4dd0e1; text-shadow: 0 0 6px rgba(77, 208, 225, 0.6); }
        .title-Pro { color: #ffd54f; text-shadow: 0 0 7px rgba(255, 213, 79, 0.7); }
        .title-Legend { color: #ba68c8; text-shadow: 0 0 8px rgba(186, 104, 200, 0.8); }
        .title-Champion { color: #ff8a65; text-shadow: 0 0 10px rgba(255, 138, 101, 0.9); animation: champion-glow 2s infinite alternate; }
        
        @keyframes champion-glow {
            from { text-shadow: 0 0 8px rgba(255, 138, 101, 0.7); }
            to { text-shadow: 0 0 16px rgba(255, 138, 101, 1); }
        }
    </style>
</head>
<body>

{% if intro %}
<div class="card">
    <h1>‚ùì Guess the Number</h1>
    <form method="POST">
        <input type="text" name="username" placeholder="Enter your name (up to 12)" maxlength="12" required autofocus>
        <input type="hidden" name="form_type" value="set_username">
        <button>Next</button>
    </form>
</div>
{% else %}
<div class="top-menu">
    <form method="POST"><input type="hidden" name="form_type" value="go_back"><button>Back</button></form>
    <button data-section="game">Game</button>
    <button data-section="stats">Stats</button>
    <button data-section="leaderboard">Leaderboard</button>
    <button data-section="titles">Titles</button>
</div>

<div class="card">
    <h1 style="text-align: center;">‚ùì Guess the Number</h1>
    <p style="text-align: center;">Player: <strong>{{ username }}</strong></p>

    <div id="game-section" class="section" style="display:block;">
        <form method="POST" class="difficulty-container">
            <label>Difficulty:</label>
            <select name="difficulty">
                <option value="easy" {% if difficulty=='easy' %}selected{% endif %}>Easy 1-10 | 3 pts</option>
                <option value="medium" {% if difficulty=='medium' %}selected{% endif %}>Medium 1-50 | 9 pts</option>
                <option value="hard" {% if difficulty=='hard' %}selected{% endif %}>Hard 1-100 | 17 pts</option>
                <option value="impossible" {% if difficulty=='impossible' %}selected{% endif %}>Impossible 1-1000 | 40 pts</option>
            </select>
            <button type="submit" name="form_type" value="set_difficulty">Set</button>
        </form>

        {% if not game_ready %}
            <form method="POST" style="text-align: center;">
                <input type="hidden" name="form_type" value="start_guessing">
                <button>Start Game</button>
            </form>
        {% else %}
            <form method="POST" style="text-align: center;">
                <label>Guess:</label>
                <input type="number" name="guess" placeholder="Enter your guess number" required autofocus style="width: auto; max-width: 200px;">
                <input type="hidden" name="form_type" value="make_guess">
                <button style="width: auto;">Guess</button>
            </form>
        {% endif %}

        <p class="game-message" style="text-align: center;">{{ message }}</p>

        {% if game_ready and guess_history %}
            <p style="text-align: center;">Your Guesses: {{ guess_history | join(', ') }}</p>
        {% endif %}

        <p class="timer" style="text-align: center;">‚è±Ô∏è Time: <span id="timer">{{ timer }}</span> sec</p>

        {% if '‚úÖ' in message %}
            <img src="{{ url_for('static', filename='correct.gif') }}" width="200">
        {% elif '‚ùå' in message %}
            <img src="{{ url_for('static', filename='wrong.gif') }}" width="200">
        {% endif %}
    </div>

    <div id="stats-section" class="section">
        <h2>üìä Player Stats</h2>
        <div class="stats-box" style="border-top: none; padding-top: 0;">
            <p><strong>Total Points:</strong> {{ points }}</p>
            <p><strong>Total Games Played:</strong> {{ total_games }}</p>
            {% if total_games > 0 %}
                {% set win_rate = (correct_guesses / total_games * 100) | round(1) %}
                <p><strong>Correct Guesses:</strong> {{ correct_guesses }}</p>
                <p><strong>Win Rate:</strong> {{ win_rate }}%</p>
            {% else %}
                 <p>Play a game to see your stats!</p>
            {% endif %}
        </div>
    </div>

    <div id="leaderboard-section" class="section">
        <h2>üèÜ Leaderboard</h2>
        <ul>
            {% for name, score in leaderboard %}
            <li>
                {{ loop.index }}.&nbsp;
                {% set player_title = get_title(score) %}
                {% if player_title %}
                    <span class="player-title title-{{ player_title }}">{{ player_title }}</span>
                {% endif %}
                {{ name }} - {{ score }} points
            </li>
            {% else %}
            <li>No scores yet.</li>
            {% endfor %}
        </ul>
    </div>

    <div id="titles-section" class="section">
        <h2>üèÖ Titles</h2>
        <ul>
            {% for title, pts in titles|reverse %}
            <li><span class="player-title title-{{ title }}">{{ title }}</span> - {{ pts }} points</li>
            {% endfor %}
        </ul>
    </div>
</div>

<audio id="winSound" src="{{ url_for('static', filename='win.mp3') }}"></audio>
<audio id="loseSound" src="{{ url_for('static', filename='lose.mp3') }}"></audio>
<audio id="clickSound" src="{{ url_for('static', filename='click.mp3') }}"></audio>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const showSection = (sectionId) => {
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId + '-section').style.display = 'block';
        };

        document.querySelectorAll('.top-menu button[data-section]').forEach(button => {
            button.addEventListener('click', () => showSection(button.dataset.section));
        });

        const clickSound = document.getElementById('clickSound');
        document.querySelectorAll("button").forEach(btn => {
            btn.addEventListener("click", () => {
                clickSound.currentTime = 0;
                clickSound.play().catch(e => {});
            });
        });

        const gameReady = {{ game_ready | tojson }};
        if (gameReady) {
            let seconds = {{ timer | tojson }};
            const timerElement = document.getElementById('timer');
            setInterval(() => {
                seconds++;
                timerElement.innerText = seconds;
            }, 1000);
        }

        const winSound = document.getElementById('winSound');
        const loseSound = document.getElementById('loseSound');
        
        const message = "{{ message }}"; 

        if (message.includes('‚úÖ')) {
            winSound.loop = true;
            let playPromise = winSound.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay was prevented. Playing on first click.");
                    document.body.addEventListener('click', () => winSound.play(), { once: true });
                });
            }
        } else if (message.includes('‚ùå')) {
            let playPromise = loseSound.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.log("Autoplay was prevented. Playing on first click.");
                    document.body.addEventListener('click', () => loseSound.play(), { once: true });
                });
            }
        }
    });
</script>
{% endif %}
</body>
</html>